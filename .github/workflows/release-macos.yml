# Release macOS (signed + notarized)
# Triggered on push of tags matching v*
#
# Setup: Create environment "release" with Required reviewers (Settings → Environments)
# to protect Apple credentials from contributor MRs.
#
# Environment "release" (Settings → Environments → release):
#
# Secrets:
#   MACOS_CERT_P12_BASE64   — base64-encoded P12 (Keychain → Export → base64 -i cert.p12)
#   MACOS_CERT_PASSWORD     — P12 password
#   APPLE_ID                — Apple ID email
#   APPLE_APP_SPECIFIC_PASSWORD — App-specific password (appleid.apple.com)
#
# Variables:
#   MACOS_CODESIGN_IDENTITY — "Developer ID Application: Name (TEAMID)" (security find-identity -v)
#   APPLE_TEAM_ID           — Team ID from developer.apple.com

name: Release macOS

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  Release new version:
    runs-on: macos-latest
    environment: release  # Requires approval before running (Settings → Environments → release → Required reviewers)

    steps:
      - uses: actions/checkout@v6

      # 0) Generate Xcode project
      - name: Generate Xcode project
        run: brew install xcodegen && xcodegen generate

      # 1) Create & unlock a temporary keychain, import Developer ID cert
      - name: Import Developer ID certificate
        env:
          P12_BASE64: ${{ secrets.MACOS_CERT_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
        run: |
          set -euxo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 12)"

          echo "$KEYCHAIN_PASSWORD" > "$RUNNER_TEMP/keychain_pass.txt"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Use -D for macOS compatibility (BSD base64)
          echo "$P12_BASE64" | base64 -D > "$RUNNER_TEMP/cert.p12"
          security import "$RUNNER_TEMP/cert.p12" -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security

          # Make this keychain the default for the job
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -d user -s "$KEYCHAIN_PATH"

          # Allow codesign to access the key without UI prompts
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      # 2) Set version from tag and commit
      - name: Set version
        run: |
          MARKETING_VERSION="${GITHUB_REF_NAME#v}"  # v0.3.0 → 0.3.0
          CURRENT_PROJECT_VERSION="$(git rev-parse --short HEAD)"
          echo "MARKETING_VERSION=$MARKETING_VERSION" >> "$GITHUB_ENV"
          echo "CURRENT_PROJECT_VERSION=$CURRENT_PROJECT_VERSION" >> "$GITHUB_ENV"

      # 3) Build app (adhoc signing - we re-sign with Developer ID in next step)
      - name: Build (Release)
        run: |
          set -euxo pipefail
          xcodebuild \
            -project TrueRPCMini.xcodeproj \
            -scheme TrueRPCMini \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            MARKETING_VERSION="$MARKETING_VERSION" \
            CURRENT_PROJECT_VERSION="$CURRENT_PROJECT_VERSION" \
            build

      # 4) Codesign .app (hardened runtime)
      - name: Codesign app
        env:
          CODESIGN_IDENTITY: ${{ vars.MACOS_CODESIGN_IDENTITY }}
        run: |
          set -euxo pipefail
          APP_PATH="build/Build/Products/Release/TrueRPCMini.app"

          codesign --force --options runtime --timestamp \
            --entitlements "Entitlements.plist" \
            --sign "$CODESIGN_IDENTITY" \
            "$APP_PATH"

          codesign --verify --deep --strict --verbose=2 "$APP_PATH"

      # 5) Package as DMG
      - name: Package app (dmg)
        run: |
          set -euxo pipefail
          APP_PATH="build/Build/Products/Release/TrueRPCMini.app"
          DMG_NAME="TrueRPCMini-${{ github.ref_name }}.dmg"
          hdiutil create -volname "TrueRPCMini" -srcfolder "$APP_PATH" -ov -format UDZO "$DMG_NAME"
          echo "DMG_NAME=$DMG_NAME" >> "$GITHUB_ENV"

      # 6) Notarize DMG
      - name: Notarize (notarytool)
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
        run: |
          set -euxo pipefail
          # Increase upload timeout (helps with slow/large uploads)
          defaults write com.apple.gke.notary.tool nt-upload-connection-timeout 300 2>/dev/null || true
          # Submit (without --wait) — if this hangs, upload/connection is the issue
          OUTPUT=$(xcrun notarytool submit "$DMG_NAME" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" 2>&1)
          echo "$OUTPUT"
          SUBMISSION=$(echo "$OUTPUT" | grep -oE '[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}' | head -1)
          # Wait for Apple to process (typically 1–5 min, can be 30+)
          xcrun notarytool wait "$SUBMISSION" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID"

      # 7) Staple notarization ticket onto DMG
      - name: Staple
        run: |
          set -euxo pipefail
          xcrun stapler staple "$DMG_NAME"

      # 8) Create GitHub Release + upload DMG
      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            TrueRPCMini-${{ github.ref_name }}.dmg
