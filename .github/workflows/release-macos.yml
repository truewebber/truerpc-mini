# Release macOS (signed + notarized)
# Triggered on push of tags matching v*
#
# Required secrets (Settings → Secrets and variables → Actions):
#
# MACOS_CERT_P12_BASE64
#   What: Base64-encoded P12 file with Developer ID Application certificate
#   From: Keychain Access → Export cert as .p12 → base64 -i cert.p12 | pbcopy
#   Example: MIIKXAIBAzCCCi4GCSqGSIb3DQEHAaCCCh8Eggob...
#
# MACOS_CERT_PASSWORD
#   What: Password for the P12 file (set when exporting)
#   From: You choose it when exporting from Keychain
#   Example: mySecurePassword123
#
# MACOS_CODESIGN_IDENTITY
#   What: Full identity name for Developer ID Application
#   From: security find-identity -v -p codesigning (look for "Developer ID Application")
#   Example: Developer ID Application: Your Name (57UWRPUUGM)
#
# APPLE_ID
#   What: Apple ID email (Apple Developer account)
#   From: Your Apple Developer account
#   Example: developer@example.com
#
# APPLE_APP_SPECIFIC_PASSWORD
#   What: App-specific password for notarization (not your regular Apple ID password)
#   From: https://appleid.apple.com → Sign-In and Security → App-Specific Passwords
#   Example: abcd-efgh-ijkl-mnop
#
# APPLE_TEAM_ID
#   What: Team ID from Apple Developer Program
#   From: developer.apple.com/account → Membership details
#   Example: 57UWRPUUGM

name: Release macOS

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v6

      # 0) Generate Xcode project
      - name: Generate Xcode project
        run: brew install xcodegen && xcodegen generate

      # 1) Create & unlock a temporary keychain, import Developer ID cert
      - name: Import Developer ID certificate
        env:
          P12_BASE64: ${{ secrets.MACOS_CERT_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
        run: |
          set -euxo pipefail
          KEYCHAIN_PATH="$RUNNER_TEMP/build.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 12)"

          echo "$KEYCHAIN_PASSWORD" > "$RUNNER_TEMP/keychain_pass.txt"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Use -D for macOS compatibility (BSD base64)
          echo "$P12_BASE64" | base64 -D > "$RUNNER_TEMP/cert.p12"
          security import "$RUNNER_TEMP/cert.p12" -k "$KEYCHAIN_PATH" -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security

          # Make this keychain the default for the job
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -d user -s "$KEYCHAIN_PATH"

          # Allow codesign to access the key without UI prompts
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      # 2) Build app (adhoc signing - we re-sign with Developer ID in next step)
      - name: Build (Release)
        run: |
          set -euxo pipefail
          # Override: project expects "Apple Development" but CI has only Developer ID
          xcodebuild \
            -project TrueRPCMini.xcodeproj \
            -scheme TrueRPCMini \
            -configuration Release \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="-" \
            build

      # 3) Codesign .app (hardened runtime)
      - name: Codesign app
        env:
          CODESIGN_IDENTITY: ${{ secrets.MACOS_CODESIGN_IDENTITY }}
        run: |
          set -euxo pipefail
          APP_PATH="build/Build/Products/Release/TrueRPCMini.app"

          codesign --force --options runtime --timestamp \
            --entitlements "Entitlements.plist" \
            --sign "$CODESIGN_IDENTITY" \
            "$APP_PATH"

          codesign --verify --deep --strict --verbose=2 "$APP_PATH"

      # 4) Package as DMG
      - name: Package app (dmg)
        run: |
          set -euxo pipefail
          APP_PATH="build/Build/Products/Release/TrueRPCMini.app"
          DMG_NAME="TrueRPCMini-${{ github.ref_name }}.dmg"
          hdiutil create -volname "TrueRPCMini" -srcfolder "$APP_PATH" -ov -format UDZO "$DMG_NAME"
          echo "DMG_NAME=$DMG_NAME" >> "$GITHUB_ENV"

      # 5) Notarize DMG
      - name: Notarize (notarytool)
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euxo pipefail
          xcrun notarytool submit "$DMG_NAME" \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_SPECIFIC_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait

      # 6) Staple notarization ticket onto DMG
      - name: Staple
        run: |
          set -euxo pipefail
          xcrun stapler staple "$DMG_NAME"

      # 7) Create GitHub Release + upload DMG
      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            TrueRPCMini-${{ github.ref_name }}.dmg
